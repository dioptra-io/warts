name: Tests

on: [push, pull_request]

env:
  CARGO_TERM_COLOR: "always"
  # https://github.com/mozilla/grcov#example-how-to-generate-source-based-coverage-for-a-rust-project
  LLVM_PROFILE_FILE: "%p-%m.profraw"
  RUSTC_BOOTSTRAP: "1"
  RUSTFLAGS: "-Zinstrument-coverage"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build
        run: cargo build --verbose
      - name: Run tests
        run: cargo test --verbose
      - name: Compute coverage
        run: |
          rustup component add llvm-tools-preview
          curl -L https://github.com/mozilla/grcov/releases/latest/download/grcov-x86_64-unknown-linux-gnu.tar.bz2 | tar jxf -
          ./grcov . --binary-path ./target/debug/ -s . -t lcov --branch --ignore-not-existing --ignore "/*" -o lcov.info
      - uses: codecov/codecov-action@v2
